<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>2025 Product Roadmap – Param-Driven</title>

<!-- ──────────────────────────────────────────────────────────────
     1)  fire Activepieces /sync endpoint, wait up to 30 s
     2)  expect   { "data": "<base64-encoded-roadmap-json>" }
     3)  render(payload) OR fallback demo
     ──────────────────────────────────────────────────────────── -->
<script>
(async () => {
  const SYNC_URL = 'https://activepieces.pipefy.com/api/v1/webhooks/FX15MTvagDV7s4VM3gOVC/sync';

  /* build URL with original query-params + fresh timestamp to bust cache */
  const qp = new URLSearchParams(location.search);
  qp.set('timestamp', new Date().toISOString());
  const urlWithParams = `${SYNC_URL}?${qp.toString()}`;

  /* loading banner */
  const banner = document.createElement('div');
  banner.innerHTML = '<div style="text-align:center">Loading roadmap …<br><span id="slow" style="font-size:.9rem;opacity:0">this may take a few seconds</span></div>';
  banner.style.cssText =
    'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;' +
    'background:#f8f9fa;font:1.4rem Arial';
  document.documentElement.appendChild(banner);
  setTimeout(()=>document.getElementById('slow').style.opacity=1,10_000); // after 10 s

  /* abort after 30 000 ms */
  const fetchWithTimeout = (url, opts={}, timeout=30_000) =>
    Promise.race([
      fetch(url, opts),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),timeout))
    ]);

  let payload = null;
  try {
    const r = await fetchWithTimeout(urlWithParams);
    if (r.ok){
      const json = await r.json();             // adjust if your flow returns raw text
      if (json && json.data) payload = JSON.parse(atob(json.data));
    }
  } catch (e) {
    console.warn('Webhook fetch failed:', e);
  }
  banner.remove();
  render(payload);          // null → will use demo fallback
})();
</script>
<!-- ──────────────────────────────────────────────────────────── -->

<style>
/* ---------- Base layout ---------- */
body{margin:0;padding:32px;font-family:Arial,Helvetica,sans-serif;background:#f8f9fa}
h1{text-align:center;margin-top:0}

/* ---------- Filter bar ---------- */
.filters{display:flex;flex-wrap:wrap;gap:24px;justify-content:center;margin-bottom:24px}
fieldset{border:1px solid #ced4da;border-radius:8px;padding:12px 16px}
legend{font-weight:700;padding:0 4px}
label{margin-right:12px;white-space:nowrap}

/* ---------- Month header ---------- */
.months{display:grid;grid-template-columns:150px repeat(12,1fr);margin-bottom:16px}
.months div:nth-child(1){}
.months div{background:#e9ecef;text-align:center;line-height:40px;font-weight:600;border-radius:4px}

/* ---------- Squad rows ---------- */
.squad-row{display:flex;align-items:flex-start;gap:8px;margin-bottom:20px;border-bottom:1px solid #e3e3e3;padding-bottom:12px}
.squad-row.hidden{display:none !important}
.squad-label{flex:0 0 150px;font-weight:700}
.lane{flex:1;position:relative;min-height:36px}

/* ---------- Initiative bars ---------- */
.item{position:absolute;height:36px;border-radius:20px;padding:6px 12px;color:#fff;
      font-size:0.9rem;white-space:nowrap;display:flex;align-items:center}
.squad-1{background:#FF6B6B}.squad-2{background:#6BCB77}.squad-3{background:#4D96FF}
.squad-4{background:#FFB84C}.squad-5{background:#845EC2}.squad-6{background:#00C9A7}
.squad-7{background:#FF9671}.squad-8{background:#2C73D2}
.hidden{display:none !important}
</style>
</head>

<body>
<h1>2025 Product Roadmap</h1>

<!-- FILTERS -->
<div class="filters">
  <fieldset id="squadFilter"><legend>Squads</legend>
    <label><input type="checkbox" value="1" checked> Squad&nbsp;1</label>
    <label><input type="checkbox" value="2" checked> Squad&nbsp;2</label>
    <label><input type="checkbox" value="3" checked> Squad&nbsp;3</label>
    <label><input type="checkbox" value="4" checked> Squad&nbsp;4</label>
    <label><input type="checkbox" value="5" checked> Squad&nbsp;5</label>
    <label><input type="checkbox" value="6" checked> Squad&nbsp;6</label>
    <label><input type="checkbox" value="7" checked> Squad&nbsp;7</label>
    <label><input type="checkbox" value="8" checked> Squad&nbsp;8</label>
  </fieldset>

  <fieldset id="quarterFilter"><legend>Quarters</legend>
    <label><input type="checkbox" value="Q1" checked> Q1&nbsp;(Jan–Mar)</label>
    <label><input type="checkbox" value="Q2" checked> Q2&nbsp;(Apr–Jun)</label>
    <label><input type="checkbox" value="Q3" checked> Q3&nbsp;(Jul–Sep)</label>
    <label><input type="checkbox" value="Q4" checked> Q4&nbsp;(Oct–Dec)</label>
  </fieldset>
</div>

<!-- MONTH HEADER -->
<div class="months">
  <div></div><div>Jan</div><div>Feb</div><div>Mar</div><div>Apr</div><div>May</div><div>Jun</div>
  <div>Jul</div><div>Aug</div><div>Sep</div><div>Oct</div><div>Nov</div><div>Dec</div>
</div>

<!-- SQUAD ROWS -->
<div id="rows"></div>

<!-- ========= timeline renderer ========= -->
<script>
function render(payload){
  const BAR_H=36,GAP=16,t0=new Date('2025-01-01'),t1=new Date('2026-01-01');
  const MS=86_400_000,days=(t1-t0)/MS;

  const demoSquads=['Squad 1','Squad 2','Squad 3','Squad 4','Squad 5','Squad 6','Squad 7','Squad 8'];
  const demoInitiatives=[{squad:1,label:'Login Revamp',start:'2025-01-05',end:'2025-02-19'}];

  const squads=payload?.squads??demoSquads;
  const inits =payload?.initiatives??demoInitiatives;

  const rows=document.getElementById('rows');
  rows.innerHTML='';
  for(let s=1;s<=squads.length;s++){
    const row=document.createElement('div');row.className='squad-row';row.dataset.squad=s;
    const label=document.createElement('div');label.className='squad-label';label.textContent=squads[s-1]??`Squad ${s}`;
    const lane=document.createElement('div');lane.className='lane';lane.id=`lane-${s}`;
    row.append(label,lane);rows.appendChild(row);
  }

  const quartersBetween=(a,b)=>{const set=new Set(),d=new Date(a.getFullYear(),a.getMonth(),1);
    while(d<=b){set.add('Q'+(Math.floor(d.getMonth()/3)+1));d.setMonth(d.getMonth()+1);}return[...set];};

  inits.forEach(i=>{
    const s=new Date(i.start),e=new Date(i.end),off=(s-t0)/MS,len=(e-s)/MS+1;
    const bar=document.createElement('div');bar.className=`item squad-${i.squad}`;
    bar.style.left=`${100*off/days}%`;bar.style.width=`${100*len/days}%`;bar.textContent=i.label;
    bar.dataset.squad=i.squad;bar.dataset.quarters=quartersBetween(s,e).join(',');
    bar.dataset.startOff=off;bar.dataset.endOff=off+len;
    document.getElementById(`lane-${i.squad}`).appendChild(bar);
  });

  const squadCbs=[...document.querySelectorAll('#squadFilter input')];
  const quartCbs=[...document.querySelectorAll('#quarterFilter input')];
  const bars=[...document.querySelectorAll('.item')];
  const rowEls=[...document.querySelectorAll('.squad-row')];

  squadCbs.forEach(cb=>cb.addEventListener('change',apply));
  quartCbs.forEach(cb=>cb.addEventListener('change',apply)); apply();

  function apply(){
    const onS=squadCbs.filter(c=>c.checked).map(c=>c.value);
    const onQ=quartCbs.filter(c=>c.checked).map(c=>c.value);
    bars.forEach(b=>{
      const okS=onS.includes(b.dataset.squad);
      const okQ=b.dataset.quarters.split(',').some(q=>onQ.includes(q));
      b.classList.toggle('hidden',!(okS&&okQ));
    });
    for(let s=1;s<=squads.length;s++){
      const lane=document.getElementById(`lane-${s}`);
      const vis=[...lane.querySelectorAll('.item:not(.hidden)')].sort((a,b)=>a.dataset.startOff-b.dataset.startOff);
      const ends=[];
      vis.forEach(bar=>{
        const start=+bar.dataset.startOff,end=+bar.dataset.endOff;
        let idx=ends.findIndex(x=>x<start);
        if(idx===-1){idx=ends.length;ends.push(end);}else ends[idx]=end;
        bar.style.top=`${idx*(BAR_H+GAP)}px`;
      });
      lane.style.height=`${ends.length?ends.length*BAR_H+(ends.length-1)*GAP:BAR_H}px`;
    }
    rowEls.forEach(r=>{
      const any=[...r.querySelectorAll('.item')].some(b=>!b.classList.contains('hidden'));
      r.classList.toggle('hidden',!any);
    });
  }
}
</script>
</body>
</html>
